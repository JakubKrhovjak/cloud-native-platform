# External Secrets configuration for Grafana IAP credentials
# Syncs OAuth client credentials from Google Secret Manager to Kubernetes
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: infra-secrets-sa
  namespace: infra
  annotations:
    iam.gke.io/gcp-service-account: grud-secrets-sa@PROJECT_ID.iam.gserviceaccount.com
  labels:
    app: grafana
    component: secrets
---
apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: gcpsm-secret-store
  namespace: infra
spec:
  provider:
    gcpsm:
      projectID: PROJECT_ID
      auth:
        workloadIdentity:
          clusterLocation: europe-west1
          clusterName: grud-cluster
          serviceAccountRef:
            name: infra-secrets-sa
---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: grafana-iap-secret
  namespace: infra
  labels:
    app: grafana
    component: iap
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: gcpsm-secret-store
    kind: SecretStore
  target:
    name: grafana-iap-secret
    creationPolicy: Owner
  dataFrom:
    - extract:
        key: grafana-iap-credentials